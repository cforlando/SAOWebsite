<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Orlando Street Art</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- Place favicon.ico in the root directory -->

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/index.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css" type="text/css">
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->

  <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-100 w-75" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Image Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      
        <div class="modal-body">
          <div class="row">
            <div class="col">
              <div class="img_parent">
                <img id="art_img" src="https://via.placeholder.com/500" />
              </div>
            </div>
            <div class="col">
              <h2 id="art_title"></h2>
              <h3>
                <span>Submitted by:</span>
                <span id="art_submitted_by"></span> 
              </h3>
              <div id="mapdiv" style="width:200px;height:200px;z-index:9999"></div>

            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <header class="header_bar">
    <div class="container">
      <div class="nav_wrapper">
        <nav class="navbar navbar-expand-sm">
          <ul class="navbar-nav mr-auto">
            <li class="navbar-brand">
              <img class="logo" src="./img/siteLogo.png" />
            </li>
            <li class="navbar-brand mt-2">Orlando Street Art</li>
          </ul>
          <i class="fas fa-bars"></i>
        </nav>
      </div>
    </div>
  </header>

  <!-- temp; this section will be part of an infinite lazy loader -->
  <section id="gallery">
    <div class="grid_container container">
      <div class="row text-center" id="gallery_page_1">

      </div>
    </div>
  </section>

  <!-- popper.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <!-- jquery -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <!-- bootstrap.js -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <!-- modernizr -->
  <script src="js/vendor/modernizr-3.6.0.min.js"></script>
  <!-- axios -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <!-- lazyload-->
  <script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@11.0.2/dist/lazyload.min.js"></script>
  <!-- lodash.js -->
  <script src="./js/lodash.js"></script>
  <!-- OpenLayers API -->
  <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>

  <script>window.jQuery || document.write('<script src="js/vendor/jquery-3.3.1.min.js"><\/script>')</script>
  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>

  <script>
    let photoInfo = {};
    let map = new ol.Map();
    let mapSource = new ol.source.OSM();
    let currPage = 1;
    let imgsPerPage = 12;

    $(document).ready(() => {
      
      var lazyLoadInstance = new LazyLoad({
        elements_selector: ".lazy"
      });

      axios.get('https://sao-api.herokuapp.com/api/submissions?page=1&per_page=12', {
          headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
          }
      }).then(
          (res) => {
            let info =_.cloneDeep(res.data.submissions);
            for(subs in res.data.submissions) {
              photoInfo[res.data.submissions[subs].id] = {
                'artist': res.data.submissions[subs].artist,
                'created_at': res.data.submissions[subs].created_at,
                'description': res.data.submissions[subs].description,
                'latitude': res.data.submissions[subs].latitude,
                'location_note': res.data.submissions[subs].location_note,
                'longitude': res.data.submissions[subs].longitude,
                'nickname': res.data.submissions[subs].nickname,
                'photo_url': res.data.submissions[subs].photo_url,
                'status': res.data.submissions[subs].status,
                'thumb_url': res.data.submissions[subs].thumb_url,
                'tiny_url': res.data.submissions[subs].tiny_url,
                'title': res.data.submissions[subs].title
              }

              appendImages(currPage, res.data.submissions[subs].thumb_url, res.data.submissions[subs].id)
              if(lazyLoadInstance) {
                lazyLoadInstance.update();
              }

            }
            console.log(photoInfo);
            
            $(document).on('scroll', _.throttle(checkToLoadAjax, 300));
            
            function checkToLoadAjax() {
              if($(window).scrollTop() + $(window).height() >= $(document).height()) {
                  console.log("should load AJAX here");
              }
            }
          }).catch((err) => {
              console.log(err);
          }).then(setModalInfo)
            .finally(smallTest);
    });
    
    function retrieveImageInfo(currPage) {

    }

    function appendImages(currPage, thumbURL, id) {
      $(`#gallery_page_${currPage}`).last().append(`
        <div class="col-lg-4 col-md-6">
          <img class="gallery_img mt-2 lazy" 
                src="./img/loadingSpinner.gif"
                data-src="${thumbURL}"
                data-idnum="${id}"   
          />
        </div>
      `);
    }

    function smallTest() {
      console.log("smallTest fired");
    }
    function setModalInfo() {
      // set click event listener on every element with a gallery_img tag
      $(".gallery_img").click((ev) => {
        // snag the idnum from the gallery img and use it to populate
        // the info in the modal
        let idNum = $(ev.target).data('idnum');
        photoInfo[idNum].thumb_url 
          ? $("#art_img").attr("src", photoInfo[idNum].thumb_url)
          : $("#art_img").attr("src", "https://via.placeholder.com/200"); // will eventually be error img
        photoInfo[idNum].title
          ? $("#art_title").text(photoInfo[idNum].title)
          : $("#art_title").text("");
        photoInfo[idNum].nickname
          ? $("#art_submitted_by").text(photoInfo[idNum].nickname)
          : $("#art_submitted_by").text("")
        
        
        $("#infoModal").modal('show', idNum);
      });         
    }

    $("#infoModal").on("shown.bs.modal", (e) => {
      // This works to pass the idNum into the modal. I don't know why.
      // It's very hackish and I'll likely replace it with something better
      // later. For now, it works.
      console.log(e.relatedTarget);
      map.setTarget(null);
      initMap();
      updateMap(e.relatedTarget);
    });

    function updateMap(idNum) {
      map.set("target", "mapdiv");
      map.set("layers", [ new ol.layer.Tile({ source: mapSource }) ]);
      map.set("view", new ol.View({ 
        center: ol.proj.fromLonLat(
          [parseFloat(photoInfo[idNum].longitude), parseFloat(photoInfo[idNum].latitude)]
        ), 
        zoom: 16} 
        ));
      
      let markerSVG = `<?xml version="1.0" encoding="UTF-8"?>
                        <svg version="1.1" id="marker-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
                        <path id="path4133" d="M7.5,0C5.0676,0,2.2297,1.4865,2.2297,5.2703&#xA;&#x9;C2.2297,7.8378,6.2838,13.5135,7.5,15c1.0811-1.4865,5.2703-7.027,5.2703-9.7297C12.7703,1.4865,9.9324,0,7.5,0z"/>
                      </svg>`;

      let markerStyle = new ol.style.Style({
        image: new ol.style.Icon(/** @type {module:ol/style/Icon~Options} */ ({
          anchor: [0.5, 0.5],
          anchorXUnits: 'fraction',
          anchorYUnits: 'fraction',
          src: 'data:image/svg+xml;base64,' + btoa(markerSVG)
        }))
      });
      
      let vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
          features: [new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.transform(
              [parseFloat(photoInfo[idNum].longitude), parseFloat(photoInfo[idNum].latitude)],
              'EPSG:4326',
              'EPSG:3857'))
          })]
        }),
        style: markerStyle
      });

      map.addLayer(vectorLayer);
    }
    
    function initMap() {
      map = new ol.Map({
          target: 'mapdiv',
          layers: [
            new ol.layer.Tile({
              source: mapSource
            })
          ],
          view: new ol.View({
            center: ol.proj.fromLonLat([0, 0]),
            zoom: 4
          })
        });
    }
  </script>

  <!-- curl "https://sao-api.herokuapp.com/api/submissions?page=8&per_page=10" \
     -H 'Content-Type: application/json' \
     -H 'Accept: application/json'-->
  <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID. -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-XXXXX-Y', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>
</body>

</html>